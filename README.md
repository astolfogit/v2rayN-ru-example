<h1>Пример использования клиента v2rayN для обхода цензуры в РФ</h1>

v2rayN - клиент для Windows, поддерживающий такие ядра, как [Xray](https://github.com/XTLS/Xray-core), [v2fly](https://github.com/v2fly/v2ray-core) и [другие](https://github.com/2dust/v2rayN/wiki/List-of-supported-cores) (взято из [официального репозитория](https://github.com/2dust/v2rayN) проекта).
Данный клиент содержит множество продвинутых фич для управления проксируемым трафиком, регулярно обновляется и имеет модульное исполнение (бинарные файлы ядер используются в чистом виде и обновляются независимо от самого клиента), что выделяет его на фоне других графических клиентов для соответствующих ядер.

===

В данном примере рассмотрим использование этого клиента с удаленным сервером, настроенным для протокола VLESS.

Использовать будем ядро [sing-box](https://github.com/SagerNet/sing-box) и режим туннеля вместо системного прокси.

===

<ol>
<li>Скачиваем крайнюю версию клиента из вкладки <a href="https://github.com/2dust/v2rayN/releases">релизов</a> официального репозитория.</li>
<br />
Сразу же в настройках совместимости в свойстах <b>v2rayN.exe</b> поставим запуск от имени администратора. Это необходимо для использования режима <b>tun</b>.

По дефолту язык приложения - китайский, сменим его на английский (не рекомендую использовать русский; перевод может содержать неточности + при необходимости обращения за поддержкой к китайским коллегам-разработчикам нам в любом случае понадобится английский).
Для этого кликнем на кнопку контекстного меню сверху справа и в появившейся вспылвашке вместо <b>zh</b> выберем <b>en</b>.
<br />
<details> <summary>Наглядно</summary> <img src="assets/zh2en.png" alt="drawing" width="555" height="434"/> </details>

Закрываем окно приложения, закрываем его в трее, нажав на самую нижнюю кнопку в появившейся над иконкой в трее всплывашке. Запускаем заново - язык должен смениться на английский.
<br />
<li>Во вкладочке <tt>Settings - Option Setting</tt> можете изменить приглянувшиеся вам настройки.</li> 
<br />
Если не знаете - не трогайте (c). Если нужно - поставим <b>Start on boot</b> во вкладке <tt>v2rayN settings</tt>.
<br /> <br />
<li>Добавляем наш сервер VLESS, нажав на соответствующую кнопку слева сверху.</li>
<br />
Заполняем все либо ручками, либо нажимаем <tt>Import bulk URL...</tt>, если у вас есть URI по типу <i>vless://here-goes-server-info</i>. Справа сверху в окошке с параметрами сервера выбираем <b>sing-box</b>.
<br /><br />
<details> <summary>Наглядно</summary> <img src="assets/server-settings.png" alt="drawing" width="555" height="540"/> </details>

<li>Переходим в <tt>Settings - Routing Setting</tt>.</li>
<br />
<ul>
<li>Правая кнопка - <tt>Add</tt>.</li>

<li><tt>Remarks</tt> - название листа, не имеет значения.</li>

<li><tt>sing-box domain strategy</tt> - <i>ipv4_only</i>, если ваш провайдер предоставляет только ipv4.</li>
В пустой области снизу добавляем правила по вашему усмотрению. В <a href="https://sing-box.sagernet.org/configuration/route/rule/">официальной документации</a> sing-box описаны все доступные поля, что они означают и чем их заполнять.
<br />
Мое предпочтение такое:
в direct (в обход прокси) отправляем все что связано с РФ. Для этого в колонну <tt>Domain</tt> мы вписываем все <a href="https://github.com/SagerNet/sing-geosite/tree/rule-set">rule-set</a>, связанные с РФ, домен верхнего уровня <i>.ru</i> и какие-либо другие домены, доступ к которым мы хотим получать напрямую.
В колонку <tt>IP or IP CIDR</tt> попадают <i>geoip:ru, geoip:private</i>.
<br /><br />
<details> <summary>Наглядно</summary> <img src="assets/geo-routing.png" alt="drawing" width="555" height="540"/> </details>

<li>Сохраняем правило кнопкой <b>Confirm</b> и создаем еще одно.</li>

В этот раз <tt>outboundTag</tt> у нас <b>proxy</b>, а в колонку <tt>Full process name</tt> мы запишем названия исполняемых файлов программ, трафик которых мы хотим проксировать. У меня это <b>chrome.exe, Discord.exe, Telegram.exe</b>.

<b>Внимание! Case-sensitive!</b>

<sup><i>(поле чувствительно к регистру, discord.exe оно уже не найдет)</i></sup>
<br />

<li>Вишенкой на торте (третьим правилом)</li> будет являться пуск в direct всего остального трафика, т.е. порты <i>0-65535</i>. Добавляем это значение в строку <tt>port</tt> под outboundTag (который <b>direct</b>).
Таким образом у нас будет проксироваться только трафик нужных нам приложений, причем трафик до российских хостов (и любых других выбранных направлений) пойдет напрямую.
</ul>

<li>Наконец, <tt>Settings - DNS Settings</tt></li>
<br />
Переходим во вкладку <tt>sing-box</tt>. В правое поле (TunMode settings) пишем кусок json, ответственный за dns. В данном случае все запросы для ru доменов отправляются провайдерскому dns, а остальные DoH резолверу Cloudflare. Приятный бонус - рекламные домены резолвиться не будут.
<br /><br />

```json
{
  "servers": [
    {
      "tag": "remote",
      "address": "https://1.1.1.1/dns-query",
      "strategy": "ipv4_only",
      "detour": "proxy"
    },
    {
      "tag": "local",
      "address": "192.168.1.1",
      "strategy": "ipv4_only",
      "detour": "direct"
    },
    {
      "tag": "block",
      "address": "rcode://success"
    }
  ],
  "rules": [
    {
      "domain_suffix": [
        ".ru"
      ],
      "rule_set": [
        "geosite-category-gov-ru",
        "geosite-yandex",
        "geosite-mailru"
      ],
      "server": "local"
    },
    {
      "rule_set": [
        "geosite-category-ads-all"
      ],
      "server": "block"
    }
  ],
  "final": "remote"
}
```

Подтверждаем изменения и на главном экране клиента в самом низу переключаем <tt>Enable Tun</tt>. Остается только следить за консолью и надеяться, что никаких error там не вылезет. Проверить работу маршрутизации можно, например, при помощи <i>https://yandex.com/internet/</i> (должен отобразить ваш локальный ip) и https://fast.com (должен начать тестирование).

</ol>
